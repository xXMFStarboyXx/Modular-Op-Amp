//
// my_analog_lib/building_blocks/DominantPoleIntegrator.vams
//
// Description: High-gain integrator stage. Uses the numerically stable `idt()`
//              function to model the dominant pole and GBW.
//

`include "disciplines.vams"
`include "constants.vams"

module DominantPoleIntegrator (in_p, in_n, out);
    input in_p, in_n;
    output out;
    electrical in_p, in_n, out;

    // Parameters for this stage
    parameter real gbw = 5M from (0:inf);    // The GBW in Hz determines the integration constant
    parameter real R_in = 1G;                 // Input resistance for convergence
    parameter real gain_max = 5000;            // Max DC gain to prevent infinite gain at DC

    analog begin
        real gbw_rads = 2 * `M_PI * gbw;

        // Model the input resistance
        I(in_p, in_n) <+ V(in_p, in_n) / R_in;

        // Model a "leaky" integrator. The idt() provides the 1/s response.
        // The second term `V(out)/gain_max` creates a "leak" which limits
        // the DC gain to `gain_max`, preventing a DC convergence error.
        I(out) <+ idt(V(in_p, in_n) * gbw_rads) + V(out)/gain_max;
    end
endmodule